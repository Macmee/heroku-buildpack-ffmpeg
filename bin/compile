#!/bin/bash

# Add library package URLs to the top here
declare -A PACKAGES
PACKAGES["x264"]="git://git.videolan.org/x264.git"
PACKAGES["yasm"]="http://www.tortall.net/projects/yasm/releases/yasm-1.2.0.tar.gz"
PACKAGES["webm"]="http://webm.googlecode.com/files/libvpx-v1.3.0.zip"

FFMPEG_URL="https://github.com/FFmpeg/FFmpeg.git"
BUILD_DIR=$1
PROFILE_PATH="$BUILD_DIR/.profile.d/ffmpeg.sh"
VENDOR_DIR="vendor"
FFMPEG_BUILD_DIR="ffmpeg_build"
FFMPEG_BUILD_DIR="ffmpeg_src"
BUILD_PATH="$BUILD_DIR/$VENDOR_DIR/$FFMPEG_BUILD_DIR"
SOURCE_PATH="$BUILD_DIR/$VENDOR_DIR/$FFMPEG_SRC_DIR"

indent() {
    sed -u 's/^/       /'
}

# Convenience method
installLibs() {
    for FFMPEG_LIB_URL in "${!PACKAGES[@]}"
    do
	extension=$(echo FFMPEG_LIB_URL | awk -F . '{print $NF}')
	if [ ${extension} == "git" ]
	then
	    git clone FFMPEG_LIB_URL
	elif [ ${extension} == "tar" ]
	then
		#extension=$(echo FFMPEG_LIB_URL | awk -F . '{print $(NF - 1)}')
	    curl -L  -s $FFMPEG_LIB_URL | tar xvzf 
	fi

	./configure --prefix=$(pwd)'/bin' > /dev/null
	make && make install > /dev/null
    done
}

echo "-----> Install ffmpeg and needed libs"
# Create place for profile path
mkdir -p $(dirname $PROFILE_PATH)

# Go into vendor dir
cd $BUILD_DIR
mkdir -p $VENDOR_DIR
cd $VENDOR_DIR
mkdir -p $FFMPEG_BUILD_DIR
mkdir -p $FFMPEG_SRC_DIR
cd $FFMPEG_SRC_DIR

# Get yasm
echo "-----> Fetching yasm..." | indent
curl -L -s http://www.tortall.net/projects/yasm/releases/yasm-1.2.0.tar.gz > yasm-1.2.0.tar.gz
tar xvzf yasm-1.2.0.tar.gz > /dev/null
cd yasm-1.2.0
./configure -q --prefix="$BUILD_PATH" --bindir="$BUILD_PATH/bin" > /dev/null
make && make install > /dev/null
echo 'export PATH="$PATH:$BUILD_PATH/bin"' >> $PROFILE_PATH
echo '-----> Profile path is now '$PATH | indent
cd ..

# Get x264
echo "-----> Fetching x264 lib..." | indent
git clone git://git.videolan.org/x264.git
cd x264
./configure --prefix="$BUILD_PATH" --bindir="$BUILD_PATH/bin" --enable-static
make && make install > /dev/null
cd ..

# Get webm
echo "-----> Fetching webm lib..." | indent
curl -L -s http://webm.googlecode.com/files/libvpx-v1.1.0.tar.bz2 > libvpx-v1.1.0.tar.bz2
tar xvjf libvpx-v1.1.0.tar.bz2 > /dev/null
cd libvpx-v1.1.0
./configure -q --prefix="$BUILD_PATH" --disable-examples > /dev/null
make && make install > /dev/null
cd ..

# Get libmp3-lame
echo "-----> Fetching libmp3-lame lib..." | indent
curl -L -s http://downloads.sourceforge.net/project/lame/lame/3.99/lame-3.99.5.tar.gz > lame-3.99.5.tar.gz
tar xzvf lame-3.99.5.tar.gz > /dev/null
cd lame-3.99.5
./configure -q --prefix="$BUILD_PATH" --enable-nasm --disable-shared
make && make install > /dev/null
cd ..

# Get fdk-aac lib
echo "-----> Fetching fdk-aac lib..." | indent
curl -L -s http://softlayer-dal.dl.sourceforge.net/project/opencore-amr/fdk-aac/fdk-aac-0.1.3.tar.gz > fdk-aac-0.1.3.tar.gz
tar xzvf fdk-aac-0.1.3.tar.gz > /dev/null
cd fdk-aac-0.1.3
autoreconf -fiv
./configure -q --prefix="$BUILD_PATH" --disable-shared
make && make install
cd ..

# NOW get ffmpeg
echo "-----> Fetching ffmpeg..." | indent
curl -L -s http://ffmpeg.org/releases/ffmpeg-snapshot.tar.bz2 > ffmpeg-snapshot.tar.bz2
tar xjvf ffmpeg-snapshot.tar.bz2 > /dev/null

echo "-----> Installing ffmpeg..." | indent
cd FFmpeg
./configure --prefix="$BUILD_PATH/bin" --extra-cflags="-I$BUILD_PATH/include" --extra-ldflags="-L$BUILD_PATH/lib" --bindir="$BUILD_PATH/bin" \
--enable-gpl --enable-version3 --enable-nonfree --enable-postproc \
--enable-libmp3lame --enable-libopencore-amrnb --enable-libvorbis --enable-libvpx \ 
--enable-libx264 --enable-libxvid > /dev/null
make && make install
cd ..

# RM downloaded archives for needed libraries
rm *.tar.gz
rm *.tar.bz2

echo "Finished building ffmpeg and libraries." | indent
